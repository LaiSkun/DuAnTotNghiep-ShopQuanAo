<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Modern Admin Dashboard</title>
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.js"></script>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">

<link rel="stylesheet" th:href="@{/css/admin.css}">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
	integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet"
	href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body ng-app="myapp" ng-controller="authority-ctrl">
	<input type="checkbox" id="menu-toggle">
	<div th:replace="admin/sidemenu :: div"></div>
	<div class="main-content">

		<header>
			<div class="header-content">
				<label for="menu-toggle"> <span class="las la-bars"></span>
				</label>

				<div class="header-menu">
					<label for=""> <span class="las la-search"></span>
					</label>

					<div class="notify-icon">
						<span class="las la-envelope"></span> <span class="notify">4</span>
					</div>

					<div class="notify-icon">
						<span class="las la-bell"></span> <span class="notify">3</span>
					</div>

					<div class="user">
						<div class="bg-img" style="background-image: url(img/1.jpeg)"></div>

						<span class="las la-power-off"></span> <span>Logout</span>
					</div>
				</div>
			</div>
		</header>

		<main>

			<div class="page-header">
				<h1>Other</h1>
				<small>Home / Authorizing </small>
			</div>

			<div class="page-content">

				


				<div class="records table-responsive">

					<div class="record-header">
						<div class="add">
							<span>Entries</span> <select name="" id="">
								<option value="">ID</option>
							</select>

						</div>

						<div class="browse">
							<input type="search" placeholder="Search" class="record-search">
							<select name="" id="">
								<option value="">Status</option>
							</select>
						</div>
					</div>

					<div>
						<table width="100%">
							<thead>
								<tr>
									<th></th>
									<th ng-repeat="role in roles" class="text-center">{{role.rolename}}</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="acc in admins">
									<td>{{acc.username}}</td>
									<th ng-repeat="role in roles" class="text-center"><input
										ng-checked="authority_of(acc, role)"
										ng-click="authority_changed(acc, role)" type="checkbox">
									</th>
								</tr>
							</tbody>
						</table>
					</div>

				</div>

			</div>

		</main>

	</div>
	<script>
	var app = angular.module("myapp", []);
	app.controller("authority-ctrl", function($scope, $http, $location) {
		$scope.roles = [];
		$scope.admins = [];
		$scope.authorities = [];
		
		$scope.initialize = function() {
			$http.get("/admin/roles").then(resp => {
				$scope.roles = resp.data;
			})
			
			$http.get("/admin/checkadmin").then(resp => {
				$scope.admins = resp.data;
			})
			$http.get("/admin/authorities").then(resp => {
			$scope.authorities = resp.data;
		}).catch(error => {
			$location.path("/unauthorized");
		})
		}
		
			$scope.authority_of = function(acc, role) {
				if($scope.authorities){
					return $scope.authorities.find(ur => ur.user.userID == acc.userID && ur.role.roleID == role.roleID);
				}
			}
			$scope.authority_changed = function(acc, role){
				var authority = $scope.authority_of(acc, role);
				if(authority){ /* đã cấp quyền -> thu hồi quyền */
					$scope.revoke_authority(authority);
				}else{ /* ngược lại nếu chưa cấp quyền -> thêm mới */
					authority = {user: acc, role: role};
					$scope.grant_authority(authority);
				}
			}
			/* Thêm mới authority */
			$scope.grant_authority = function(authority){
				$http.post(`/admin/authorities`, authority).then(resp => {
					$scope.authorities.push(resp.data)
					alert("Cấp quyền sử dụng thành công");
				}).catch(error => {
					alert("Cấp quyền sử dụng thất bại");
					console.log("Error", error);
				})
			}
			/* Xóa authority */
			$scope.revoke_authority = function(authority) {
				$http.delete(`/admin/authorities/${authority.authoritiesID}`).then(resp => {
					var index = $scope.authorities.findIndex(a => a.authoritiesID == authority.authoritiesID);
					$scope.authorities.splice(index, 1);
					alert("Thu hồi quyền sử dụng thành công");
				}).catch(error =>{
					alert("Thu hồi quyền sử dụng thất bại");
					console.log("Error", error);
				})
			}
			$scope.initialize();
	});
	</script>
</body>
</html>